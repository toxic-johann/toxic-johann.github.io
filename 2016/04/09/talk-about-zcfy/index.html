<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>众成翻译术语辅助模块分析 | Toxic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="to-xic">
  
  
    <meta name="description" content="这篇文章是李老师让我写的在众成翻译里我所负责开发的部分。众成翻译中的术语模块是由我和玉文两人共同完成的。所花时间也不算太长，在年前完成的，大概工期好像是两周吧。因为当时候也有其他工作。个人觉得难度也不大.后端使用的是thinkjs2.0，前端用webpack进行babel编译等，开发上可以使用很多es6的特性，做起来也是令人愉悦的。
因为使用的是2.0.16版本，在开发的自动编译上还是有一点小瑕疵">
  
  <meta name="description" content="这篇文章是李老师让我写的在众成翻译里我所负责开发的部分。众成翻译中的术语模块是由我和玉文两人共同完成的。所花时间也不算太长，在年前完成的，大概工期好像是两周吧。因为当时候也有其他工作。个人觉得难度也不大.后端使用的是thinkjs2.0，前端用webpack进行babel编译等，开发上可以使用很多es6的特性，做起来也是令人愉悦的。
因为使用的是2.0.16版本，在开发的自动编译上还是有一点小瑕疵">
<meta property="og:type" content="article">
<meta property="og:title" content="众成翻译术语辅助模块分析">
<meta property="og:url" content="http://yoursite.com/2016/04/09/talk-about-zcfy/index.html">
<meta property="og:site_name" content="Toxic">
<meta property="og:description" content="这篇文章是李老师让我写的在众成翻译里我所负责开发的部分。众成翻译中的术语模块是由我和玉文两人共同完成的。所花时间也不算太长，在年前完成的，大概工期好像是两周吧。因为当时候也有其他工作。个人觉得难度也不大.后端使用的是thinkjs2.0，前端用webpack进行babel编译等，开发上可以使用很多es6的特性，做起来也是令人愉悦的。
因为使用的是2.0.16版本，在开发的自动编译上还是有一点小瑕疵">
<meta property="og:updated_time" content="2016-04-09T06:50:01.956Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="众成翻译术语辅助模块分析">
<meta name="twitter:description" content="这篇文章是李老师让我写的在众成翻译里我所负责开发的部分。众成翻译中的术语模块是由我和玉文两人共同完成的。所花时间也不算太长，在年前完成的，大概工期好像是两周吧。因为当时候也有其他工作。个人觉得难度也不大.后端使用的是thinkjs2.0，前端用webpack进行babel编译等，开发上可以使用很多es6的特性，做起来也是令人愉悦的。
因为使用的是2.0.16版本，在开发的自动编译上还是有一点小瑕疵">
  
    <link rel="alternate" href="/atom.xml" title="Toxic" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?9d865e87f3199160311b03cd56126f47";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

</script>

</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Toxic</a></h1>
    <p><a href="/">李猜猜，被折磨得死去活来的菜鸟</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/04/09/talk-about-zcfy/">
  <time datetime="2016-04-09T05:43:45.000Z">
    2016-04-09
  </time>
</a>
    
    
  
    <h1 class="title">众成翻译术语辅助模块分析</h1>
  

  </header>
  
  <div class="entry">
    
      <p>这篇文章是李老师让我写的在众成翻译里我所负责开发的部分。众成翻译中的术语模块是由我和玉文两人共同完成的。所花时间也不算太长，在年前完成的，大概工期好像是两周吧。因为当时候也有其他工作。个人觉得难度也不大.后端使用的是thinkjs2.0，前端用webpack进行babel编译等，开发上可以使用很多es6的特性，做起来也是令人愉悦的。</p>
<p>因为使用的是2.0.16版本，在开发的自动编译上还是有一点小瑕疵，导致当时我需要开3个iterm来进行操作，有点不便，不过这个问题在2.1版本中已经极大的改观。</p>
<p>术语模块主要分为几个部分——爬取、导入、搜索、展示。下面简单介绍一下爬取、导入、搜索三个部分。</p>
<ul>
<li><strong>爬取</strong></li>
</ul>
<p>那么既然是术语的话，我们肯定需要一些官方资料，但是这种这么专业的资料也不会天然就构建好API让你取。所以我们当时讨论了以下的做法。</p>
<ol>
<li>对官方网站进行爬取，将资料搬到本地数据库上，自建API。</li>
<li>对官方网站进行拆解，每次查询对其进行调用获取资料。</li>
<li>对官方网站进行拆解，第一次查询的时候访问获取资料，并把资料保存下来，以后进行本地获取。</li>
</ol>
<p>三种方法各有优劣，第一种方法数据是拿到了，但是也增加了本地服务的压力，而且一些术语的更新可能会不及时。第二种方法转嫁了本地的压力，但是会依赖于第三方，万一对方改规则我们容易得不偿失。第三种方法是比较稳妥的方法。</p>
<p>不过因为术语的变化并不会特别大，而这种官方网站的规则也不会频繁更改，而且经检测感觉还是比较稳定。所以我们选择了前两种方法。</p>
<ol>
<li>少量的资料我们进行直接爬取，保证了我们的本地数据库里资料的健全性。</li>
<li>我们调用了<a href="http://history.cnctst.cn/" target="_blank" rel="external">中国名词委的查询接口</a>，获得较为官方的数据。</li>
</ol>
<p>那么这种爬取还是比较简单的。因为所有的资料都在页面上，所以我们直接用request获得页面，然后对页面进行正则获取需要的资料即可。又或者用cheerio对页面进行构建而取出所需资料。</p>
<p>我们直接观看玉文所编写的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mcw:text =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">        request(&#123;</span><br><span class="line">            url: <span class="string">'http://www.cnctst.cn/Search/SingleResultPager'</span>,</span><br><span class="line">            method: <span class="string">'POST'</span>,</span><br><span class="line">            headers: &#123;</span><br><span class="line">                <span class="string">'X-Requested-With'</span>: <span class="string">'XMLHttpRequest'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            formData: &#123;</span><br><span class="line">                handler: <span class="string">''</span>,</span><br><span class="line">                queryModel: <span class="string">'0'</span>,</span><br><span class="line">                queryWord: text,</span><br><span class="line">                orderIdx: <span class="string">'0'</span>,</span><br><span class="line">                pIdx: <span class="string">'0'</span>,</span><br><span class="line">                pSize: <span class="string">'10'</span>,</span><br><span class="line">                codes: <span class="string">'GB'</span>,</span><br><span class="line">                isfull: <span class="string">'true'</span>,</span><br><span class="line">                pCode: <span class="string">'GB'</span>,</span><br><span class="line">                viewIdx: <span class="string">'1'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            encoding: <span class="literal">null</span></span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, res, body</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> $ = cheerio.load(body.toString(), &#123;</span><br><span class="line">            normalizeWhitespace: <span class="literal">true</span>,</span><br><span class="line">            xmlMode: <span class="literal">false</span>,</span><br><span class="line">            decodeEntities: <span class="literal">false</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">var</span> response = [];</span><br><span class="line">            $(<span class="string">'#itemgrid'</span>).find(<span class="string">'tr'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">i, item</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> td = $(item).find(<span class="string">'.qd_descg'</span>);</span><br><span class="line">                <span class="keyword">if</span> (td.length) &#123;</span><br><span class="line">                    <span class="keyword">var</span> one = &#123;&#125;;</span><br><span class="line">                    one.zh_Hans = td.eq(<span class="number">0</span>).text();</span><br><span class="line">                    one.subject = td.eq(<span class="number">2</span>).text();</span><br><span class="line">                    response.push(one);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            resolve(response);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>请求接口，获得返回数据，然后用cheerio.load进行构建，挑出tr获得结果。</p>
<ul>
<li><strong>导入</strong></li>
</ul>
<p>导入是允许客户用CSV格式文件导入自己的术语。这个我们直接采用csvtojson进行处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Converter=<span class="built_in">require</span>(<span class="string">"csvtojson"</span>).Converter;</span><br><span class="line"><span class="comment">//利用csv批量上传术语</span></span><br><span class="line"><span class="keyword">async</span> uploadtermAction()&#123;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">let</span> files = <span class="keyword">this</span>.file();</span><br><span class="line">  <span class="keyword">if</span>(files.terms.headers[<span class="string">"content-type"</span>] != <span class="string">'text/csv'</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.fail(zcret.fail(<span class="string">"FILE_TYPE_ERROR"</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> csvConverter=<span class="keyword">new</span> Converter(&#123;&#125;);</span><br><span class="line">  <span class="keyword">let</span> uid = <span class="keyword">this</span>.user.id;</span><br><span class="line">  <span class="comment">// 文件解析完毕进行处理</span></span><br><span class="line">  csvConverter.on(<span class="string">"end_parsed"</span>,<span class="keyword">async</span> terms=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> tasks = terms.map(term=&gt;&#123;</span><br><span class="line">        <span class="keyword">let</span> subject = global.zcterm.getCateId(term.subject || term[<span class="string">"学科"</span>] || term[<span class="string">"分类"</span>]);</span><br><span class="line">        <span class="keyword">let</span> tmp = &#123;</span><br><span class="line">          user_id:uid,</span><br><span class="line">          en:term.en || term[<span class="string">"英文"</span>] || term[<span class="string">"原文"</span>] || <span class="string">""</span>,</span><br><span class="line">          zh_Hans:term.zh_Hans || term[<span class="string">"中文"</span>] || term[<span class="string">"译文"</span>] || <span class="string">""</span>,</span><br><span class="line">          pos:term.pos || term[<span class="string">"词性"</span>] || <span class="string">""</span>,</span><br><span class="line">          description:term.description || term[<span class="string">"描述"</span>] || term[<span class="string">"备注"</span>] || <span class="string">""</span>,</span><br><span class="line">          subject:subject || <span class="number">701</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> insertIds = <span class="keyword">await</span> self.model(<span class="string">"term"</span>).addManyTerms(tasks);</span><br><span class="line">    <span class="keyword">if</span>(think.isArray(insertIds) &amp;&amp; insertIds.length == tasks.length)&#123;</span><br><span class="line">      <span class="keyword">return</span> self.success()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> self.fail(zcret.fail(<span class="string">"DEFAULT"</span>))</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打开文件进行解析</span></span><br><span class="line">  fs.createReadStream(files.terms.path).pipe(csvConverter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个插件对于正常的纯文字的csv文件，还是十分适用的。但是如果你的csv文件里会带上一些诸如换行符，HTML标签之类的奇奇怪怪的东西。建议慎用。或者在使用前对文本进行适当处理。</p>
<ul>
<li><strong>搜索</strong></li>
</ul>
<p>查找术语我们直接用like，现在术语量还是比较小，而且我们支持用户输入<code>*</code>和<code>?</code>进行模糊搜索。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getTerm(text,uid)&#123;</span><br><span class="line">    text = text.replace(<span class="regexp">/\*/g</span>, <span class="string">'%'</span>);</span><br><span class="line">    text = text.replace(<span class="regexp">/\?/g</span>, <span class="string">'_'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> term = <span class="keyword">await</span> <span class="keyword">this</span>.where(&#123;</span><br><span class="line">        user_id: [<span class="string">'in'</span>, uid],</span><br><span class="line">        en: [<span class="string">'like'</span>, text]</span><br><span class="line">    &#125;).select();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> term;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>众所周知，like的查询比较慢，而且如果使用方式不对，会无法使用索引优化。</p>
<p>其实这样的搜索方式，在数量比较小的时候，影响还是不会很大。</p>
<p>但是在数量大而且经常使用后，我建议还是采取有索引优化的like查询方式。如仅支持首字母是正确的模糊查询等等。这个以后再细谈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getAppsByName:<span class="function"><span class="keyword">function</span>(<span class="params">name,page</span>)</span>&#123;</span><br><span class="line">    page = page || <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getAppsWithUserByCond(&#123;app_name:[<span class="string">"like"</span>,name+<span class="string">"%"</span>]&#125;,page,<span class="string">'app.updated_at desc'</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>结语</strong></li>
</ul>
<p>总体来说，简单架起一个术语辅助功能的难度并不是很大。但是在日后的维护与优化上还是要根据需求作出适当的努力。</p>

    
  </div>
  <footer>
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
  <h1 class="title">评论</h1>
  <div class="ds-thread" data-title="众成翻译术语辅助模块分析">
  </div>
</section>
</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">to-xic</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'toxicjohann' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>